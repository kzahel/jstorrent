#!/bin/bash
# Postinstall script for JSTorrent Native Host

# $2 is the installation destination (e.g., ~/Library/Application Support/JSTorrent)
# Use it directly as INSTALL_DIR, derive USER_HOME from it
if [ -n "$2" ] && [ "$2" != "/" ]; then
    INSTALL_DIR="$2"
    # Extract user home from install path (remove /Library/Application Support/JSTorrent suffix)
    USER_HOME="${2%/Library/Application Support/JSTorrent}"
else
    # Fallback: detect console user
    CONSOLE_USER=$(stat -f "%Su" /dev/console)
    USER_HOME=$(dscl . -read /Users/"$CONSOLE_USER" NFSHomeDirectory | awk '{print $2}')
    INSTALL_DIR="$USER_HOME/Library/Application Support/JSTorrent"
fi
MANIFEST_TEMPLATE="$INSTALL_DIR/com.jstorrent.native.json.template"
BINARY_PATH="$INSTALL_DIR/jstorrent-native-host"

# Kill any running JSTorrent processes before updating binaries
# Use -x for exact process name matching (not -f which matches full command line
# and would kill the installer process itself since the PKG filename contains these strings)
pkill -x "jstorrent-native-host" 2>/dev/null || true
pkill -x "jstorrent-io-daemon" 2>/dev/null || true
pkill -x "jstorrent-link-handler" 2>/dev/null || true
# Give processes time to exit
sleep 0.5

# Ensure binaries are executable
chmod 755 "$BINARY_PATH"
chmod 755 "$INSTALL_DIR/jstorrent-io-daemon"
chmod 755 "$INSTALL_DIR/uninstall.sh"

# Install Chrome manifest
MANIFEST_DEST="$USER_HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts/com.jstorrent.native.json"
if mkdir -p "$USER_HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts" 2>/dev/null; then
    sed "s|HOST_PATH_PLACEHOLDER|$BINARY_PATH|g" "$MANIFEST_TEMPLATE" > "$MANIFEST_DEST" 2>/dev/null && chmod 644 "$MANIFEST_DEST"
fi

# Move pre-built Link Handler app to ~/Applications (preserves code signature)
SRC_APP="$INSTALL_DIR/JSTorrent Link Handler.app"
APP_PATH="$USER_HOME/Applications/JSTorrent Link Handler.app"

if [ -d "$SRC_APP" ]; then
    # Ensure ~/Applications exists
    mkdir -p "$USER_HOME/Applications"

    # Remove old version if it exists
    rm -rf "$APP_PATH"

    # Move the signed app bundle to ~/Applications
    mv "$SRC_APP" "$APP_PATH"

    # Register with LaunchServices
    /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$APP_PATH" 2>/dev/null
fi

exit 0
