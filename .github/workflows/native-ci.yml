name: Native Host CI

on:
  push:
    branches: [main]
    tags:
      - 'native-v*'
    paths:
      - 'native-host/**'
      - 'packages/**'
      - '.github/workflows/native-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'native-host/**'
      - 'packages/**'
      - '.github/workflows/native-ci.yml'

permissions:
  contents: write

defaults:
  run:
    working-directory: native-host

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release

      - name: Compile Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installers\windows\jstorrent.iss

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: native-host/installers/windows/Output/jstorrent-native-host-install-windows-x86_64.exe

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: native-host/installers/windows/Output/jstorrent-native-host-install-windows-x86_64.exe

      - name: Verify Installer
        shell: pwsh
        run: |
          # Run installer silently with logging
          $InstallerPath = ".\installers\windows\Output\jstorrent-native-host-install-windows-x86_64.exe"
          Start-Process -FilePath $InstallerPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/LOG=install.log" -Wait -NoNewWindow

          # Verify files
          $InstallDir = "$env:LOCALAPPDATA\JSTorrent"
          if (-not (Test-Path "$InstallDir\jstorrent-native-host.exe")) {
            Write-Error "Native host binary not found at $InstallDir\jstorrent-native-host.exe"
            
            Write-Host "Listing LOCALAPPDATA:"
            Get-ChildItem "$env:LOCALAPPDATA" | Select-Object Name
            
            if (Test-Path "$InstallDir") {
                Write-Host "Listing InstallDir:"
                Get-ChildItem "$InstallDir"
            } else {
                Write-Host "InstallDir does not exist."
            }
            
            if (Test-Path "install.log") {
                Write-Host "Installer Log Content:"
                Get-Content "install.log"
            } else {
                Write-Host "No install.log found."
            }
            
            exit 1
          }
          if (-not (Test-Path "$InstallDir\com.jstorrent.native.json")) {
            Write-Error "Manifest not found at $InstallDir\com.jstorrent.native.json"
            exit 1
          }

          Write-Host "Installer verification passed!"

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Installer
        run: |
          chmod +x scripts/build-macos-installer.sh
          ./scripts/build-macos-installer.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: native-host/jstorrent-native-host-install-macos-x86_64.pkg

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: native-host/jstorrent-native-host-install-macos-x86_64.pkg

      - name: Verify Installer
        run: |
          chmod +x scripts/verify-macos-installer.sh
          ./scripts/verify-macos-installer.sh

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Installer
        run: |
          chmod +x scripts/build-linux-installer.sh
          ./scripts/build-linux-installer.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: native-host/dist/jstorrent-native-host-install-linux-x86_64.tar.gz

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: native-host/dist/jstorrent-native-host-install-linux-x86_64.tar.gz

      - name: Verify Installer
        run: |
          chmod +x scripts/verify-linux-installer.sh
          ./scripts/verify-linux-installer.sh
