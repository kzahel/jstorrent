name: Native Host CI

on:
  push:
    branches: [main]
    tags:
      - 'native-v*'
    paths:
      - 'native-host/**'
      - 'packages/**'
      - '.github/workflows/native-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'native-host/**'
      - 'packages/**'
      - '.github/workflows/native-ci.yml'

permissions:
  contents: write

defaults:
  run:
    working-directory: native-host

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release

      - name: Compile Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installers\windows\jstorrent.iss

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: native-host/installers/windows/Output/jstorrent-native-host-install-windows-x86_64.exe

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: native-host/installers/windows/Output/jstorrent-native-host-install-windows-x86_64.exe

      - name: Verify Installer
        shell: pwsh
        run: |
          # Run installer silently with logging
          $InstallerPath = ".\installers\windows\Output\jstorrent-native-host-install-windows-x86_64.exe"
          Start-Process -FilePath $InstallerPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/LOG=install.log" -Wait -NoNewWindow

          # Verify files
          $InstallDir = "$env:LOCALAPPDATA\JSTorrent"
          if (-not (Test-Path "$InstallDir\jstorrent-native-host.exe")) {
            Write-Error "Native host binary not found at $InstallDir\jstorrent-native-host.exe"
            
            Write-Host "Listing LOCALAPPDATA:"
            Get-ChildItem "$env:LOCALAPPDATA" | Select-Object Name
            
            if (Test-Path "$InstallDir") {
                Write-Host "Listing InstallDir:"
                Get-ChildItem "$InstallDir"
            } else {
                Write-Host "InstallDir does not exist."
            }
            
            if (Test-Path "install.log") {
                Write-Host "Installer Log Content:"
                Get-Content "install.log"
            } else {
                Write-Host "No install.log found."
            }
            
            exit 1
          }
          if (-not (Test-Path "$InstallDir\com.jstorrent.native.json")) {
            Write-Error "Manifest not found at $InstallDir\com.jstorrent.native.json"
            exit 1
          }

          Write-Host "Installer verification passed!"

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release

      - name: Prepare PKG Root
        run: |
          # Native Host
          mkdir -p pkgroot/usr/local/lib/jstorrent-native
          cp target/release/jstorrent-host pkgroot/usr/local/lib/jstorrent-native/jstorrent-native-host
          cp installers/macos/scripts/uninstall.sh pkgroot/usr/local/lib/jstorrent-native/
          cp manifests/com.jstorrent.native.json.template pkgroot/usr/local/lib/jstorrent-native/

          # Magnet Handler App
          mkdir -p pkgroot/Applications/JSTorrentLinkHandler.app/Contents/MacOS
          cp target/release/jstorrent-link-handler pkgroot/Applications/JSTorrentLinkHandler.app/Contents/MacOS/jstorrent-link-handler
          cp installers/macos/Info.plist pkgroot/Applications/JSTorrentLinkHandler.app/Contents/

      - name: Build PKG
        run: |
          pkgbuild --root pkgroot \
                   --identifier com.jstorrent.native \
                   --version 0.1.0 \
                   --scripts installers/macos/scripts \
                   jstorrent-native-host-install-macos-x86_64.pkg

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: native-host/jstorrent-native-host-install-macos-x86_64.pkg

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: native-host/jstorrent-native-host-install-macos-x86_64.pkg

      - name: Verify Installer
        run: |
          # Install PKG
          sudo installer -pkg jstorrent-native-host-install-macos-x86_64.pkg -target /

          # Verify files
          if [ ! -f "/usr/local/lib/jstorrent-native/jstorrent-native-host" ]; then
            echo "Error: Native host binary not found in /usr/local/lib/jstorrent-native/"
            exit 1
          fi

          if [ ! -d "/Applications/JSTorrentLinkHandler.app" ]; then
            echo "Error: Magnet Handler app not found in /Applications/"
            exit 1
          fi

          echo "Installer verification passed!"

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release

      - name: Create Tarball
        run: |
          mkdir -p dist
          cp target/release/jstorrent-host dist/jstorrent-native-host
          cp target/release/jstorrent-link-handler dist/jstorrent-link-handler
          cp installers/linux/install.sh dist/
          cp installers/linux/uninstall.sh dist/
          mkdir -p dist/manifests
          cp manifests/com.jstorrent.native.json.template dist/manifests/

          tar -czvf jstorrent-native-host-install-linux-x86_64.tar.gz -C dist .

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: native-host/jstorrent-native-host-install-linux-x86_64.tar.gz

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: native-host/jstorrent-native-host-install-linux-x86_64.tar.gz

      - name: Verify Installer
        run: |
          # Simulate download and install
          mkdir -p test_install
          tar -xzf jstorrent-native-host-install-linux-x86_64.tar.gz -C test_install
          cd test_install

          # Mock Chrome config dir
          mkdir -p $HOME/.config/google-chrome/NativeMessagingHosts

          # Run install
          ./install.sh

          # Verify files
          if [ ! -f "$HOME/.local/lib/jstorrent-native/jstorrent-native-host" ]; then
            echo "Error: Native host binary not found after install"
            exit 1
          fi

          if [ ! -f "$HOME/.config/google-chrome/NativeMessagingHosts/com.jstorrent.native.json" ]; then
            echo "Error: Manifest not found after install"
            exit 1
          fi

          echo "Installer verification passed!"
