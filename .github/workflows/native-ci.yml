name: Native Host CI

on:
  push:
    branches: [main]
    tags:
      - 'native-v*'
    paths:
      - 'system-bridge/**'
      - 'packages/**'
      - '.github/workflows/native-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'system-bridge/**'
      - 'packages/**'
      - '.github/workflows/native-ci.yml'

permissions:
  contents: write

defaults:
  run:
    working-directory: system-bridge

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release --workspace

      - name: Compile Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installers\windows\jstorrent.iss

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: system-bridge/installers/windows/Output/jstorrent-native-host-install-windows-x86_64.exe

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: system-bridge/installers/windows/Output/jstorrent-native-host-install-windows-x86_64.exe

      - name: Verify Installer
        shell: pwsh
        run: |
          # Run installer silently with logging
          $InstallerPath = ".\installers\windows\Output\jstorrent-native-host-install-windows-x86_64.exe"
          Start-Process -FilePath $InstallerPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/LOG=install.log" -Wait -NoNewWindow

          # Verify files
          $InstallDir = "$env:LOCALAPPDATA\JSTorrent"
          if (-not (Test-Path "$InstallDir\jstorrent-native-host.exe")) {
            Write-Error "Native host binary not found at $InstallDir\jstorrent-native-host.exe"
            
            Write-Host "Listing LOCALAPPDATA:"
            Get-ChildItem "$env:LOCALAPPDATA" | Select-Object Name
            
            if (Test-Path "$InstallDir") {
                Write-Host "Listing InstallDir:"
                Get-ChildItem "$InstallDir"
            } else {
                Write-Host "InstallDir does not exist."
            }
            
            if (Test-Path "install.log") {
                Write-Host "Installer Log Content:"
                Get-Content "install.log"
            } else {
                Write-Host "No install.log found."
            }
            
            exit 1
          }
          if (-not (Test-Path "$InstallDir\jstorrent-io-daemon.exe")) {
            Write-Error "IO Daemon binary not found at $InstallDir\jstorrent-io-daemon.exe"
            exit 1
          }
          if (-not (Test-Path "$InstallDir\com.jstorrent.native.json")) {
            Write-Error "Manifest not found at $InstallDir\com.jstorrent.native.json"
            exit 1
          }

          Write-Host "Installer verification passed!"

  build-macos:
    runs-on: macos-latest
    env:
      HAS_SIGNING_SECRETS: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 != '' }}
      HAS_NOTARIZATION_SECRETS: ${{ secrets.ASC_API_KEY_P8_BASE64 != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up code signing
        if: env.HAS_SIGNING_SECRETS == 'true'
        env:
          MACOS_CERTIFICATE_P12_BASE64: ${{ secrets.MACOS_CERTIFICATE_P12_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE_P12_BASE64" | base64 --decode > certificate.p12
          security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$MACOS_KEYCHAIN_PASSWORD" build.keychain
          echo "Available signing identities:"
          security find-identity -v -p codesigning build.keychain
          rm -f certificate.p12

      - name: Set up notarization credentials
        if: env.HAS_NOTARIZATION_SECRETS == 'true'
        env:
          ASC_API_KEY_P8_BASE64: ${{ secrets.ASC_API_KEY_P8_BASE64 }}
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$ASC_API_KEY_P8_BASE64" | base64 --decode > ~/private_keys/AuthKey_${ASC_API_KEY_ID}.p8
          chmod 600 ~/private_keys/AuthKey_${ASC_API_KEY_ID}.p8

      - name: Build Signed Installer
        if: env.HAS_SIGNING_SECRETS == 'true'
        env:
          CODESIGN_IDENTITY: 'Developer ID Application: Kyle Graehl (VD7BYQ6ABM)'
          INSTALLER_IDENTITY: 'Developer ID Installer: Kyle Graehl (VD7BYQ6ABM)'
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_ISSUER_ID: ${{ secrets.ASC_API_ISSUER_ID }}
        run: |
          export ASC_API_KEY="$HOME/private_keys/AuthKey_${ASC_API_KEY_ID}.p8"
          chmod +x scripts/build-macos-installer.sh
          ./scripts/build-macos-installer.sh --notarize

      - name: Build Unsigned Installer
        if: env.HAS_SIGNING_SECRETS != 'true'
        run: |
          chmod +x scripts/build-macos-installer.sh
          ./scripts/build-macos-installer.sh
          echo "::warning::Building unsigned installer - code signing secrets not configured"

      - name: Verify Package
        if: env.HAS_SIGNING_SECRETS == 'true'
        run: |
          pkgutil --check-signature jstorrent-native-host-install-macos-x86_64.pkg
          spctl -a -vv -t install jstorrent-native-host-install-macos-x86_64.pkg

      - name: Clean up
        if: always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          rm -rf ~/private_keys 2>/dev/null || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: system-bridge/jstorrent-native-host-install-macos-x86_64.pkg

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: system-bridge/jstorrent-native-host-install-macos-x86_64.pkg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Installer
        run: |
          chmod +x scripts/build-linux-installer.sh
          ./scripts/build-linux-installer.sh

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: system-bridge/dist/jstorrent-native-host-install-linux-x86_64.tar.gz

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: system-bridge/dist/jstorrent-native-host-install-linux-x86_64.tar.gz

      - name: Verify Installer
        run: |
          chmod +x scripts/verify-linux-installer.sh
          ./scripts/verify-linux-installer.sh
